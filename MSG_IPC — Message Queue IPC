#include <stdio.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <string.h>
#include <sys/wait.h>
#include <unistd.h>
#include <stdlib.h>

struct msg { long mtype; char mtext[128]; };

int main() {
    key_t key = IPC_PRIVATE;
    int qid = msgget(key, IPC_CREAT | 0600);
    if (qid == -1) { perror("msgget"); return 1; }

    pid_t pid = fork();
    if (pid == 0) {
        struct msg r;
        msgrcv(qid, &r, sizeof(r.mtext), 1, 0);
        printf("Child received: %s\n", r.mtext);
        exit(0);
    } else {
        struct msg s = {1, "Message from parent via msgq"};
        msgsnd(qid, &s, strlen(s.mtext)+1, 0);
        wait(NULL);
        msgctl(qid, IPC_RMID, NULL);
    }
    return 0;
}
